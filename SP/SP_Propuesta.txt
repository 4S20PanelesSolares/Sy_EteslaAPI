DELIMITER //
CREATE PROCEDURE SP_Propuesta
(
	IN Opcion INT,
	/*Variables de Cliente*/
	IN xIdCliente VARCHAR(255),
	/*Variables para Propuesta*/
	IN xIdPropuesta VARCHAR(255),
	IN xIdPanel VARCHAR(255),
	IN xIdInversor VARCHAR(255),
	IN xIdUsuario VARCHAR(255),
	IN TipoCotizacion CHAR(12),
	IN PromedioKw FLOAT,
	IN Tarifa CHAR(10),
	IN CantidadPaneles INT,
	IN CantidadInversores INT,
	IN PotenciaPropuesta FLOAT,
	IN NuevoConsumoBimestral FLOAT,
	IN NuevoConsumoAnual FLOAT,
	IN Descuento TINYINT,
	IN PorcentajePropuesta TINYINT,
	IN SubtotalUSD FLOAT,
	IN Total FLOAT,
	IN StatusProjectFV TINYINT,
	IN daysOfExpire INT
)
BEGIN
	DECLARE expireAt TIMESTAMP;

	IF(Opcion = 0) THEN
		/*Insertar*/
		UPDATE cliente
		SET bTienePropuesta = 1
		WHERE id_Persona = UNHEX(xIdCliente);
		/*-----------------------------*/
		SET expireAt = DATE_ADD(NOW(),INTERVAL daysOfExpire DAY);
		INSERT INTO propuesta
		VALUES(UUID(), UNHEX(xIdPanel), UNHEX(xIdInversor), UNHEX(xIdCliente), UNHEX(xIdUsuario), TipoCotizacion, PromedioKw, Tarifa, CantidadPaneles, CantidadInversores, PotenciaPropuesta, NuevoConsumoBimestral, NuevoConsumoAnual, Descuento, PorcentajePropuesta, SubtotalUSD, Total, StatusProjectFV, now(), null, null, expireAt);
		SET xIdPropuesta = (SELECT HEX(idPropuesta) FROM propuesta ORDER BY idPropuesta DESC LIMIT 1);
		SELECT xIdPropuesta;
	ELSEIF (Opcion = 1) THEN
		/*Borrado logico*/
		UPDATE cliente
		SET deleted_at = now()
		WHERE idPropuesta = UNHEX(xIdPropuesta);
	ELSEIF (Opcion = 2) THEN
		/*Editar / Actualizar*/
		UPDATE propuesta
		SET id_Panel = HEX(xIdPanel), id_Inversor = HEX(xIdInversor), fPromedioKw = PromedioKw, cTarifa = Tarifa, iCantidadPaneles = CantidadPaneles, iCantidadInversores = CantidadInversores, fPotencialPropuesta = PotenciaPropuesta, fNuevoConsumoBimestral = NuevoConsumoBimestral, fNuevoConsumoAnual = NuevoConsumoAnual, tiPorcentajeDescuento = Descuento, tiPorcentajePropuesta = PorcentajePropuesta, fSubtotal = SubtotalUSD, fTotal = Total, updated_at = now();
	ELSEIF (Opcion = 3) THEN
		/*Leer => Propuestas pertenecientes a un VENDEDOR*/
		SELECT HEX(idPropuesta), HEX(id_Panel), HEX(id_Inversor), HEX(id_Cliente), HEX(id_Usuario), cTipoCotizacion, fPromedioKw, cTarifa, iCantidadPaneles, iCantidadInversores, fPotencialPropuesta, fNuevoConsumoBimestral, fNuevoConsumoAnual, tiPorcentajeDescuento, tiPorcentajePropuesta, fSubtotal, fTotal, siStatusProjejctFV, created_at, deleted_at, updated_at, expire_at
		FROM propuesta
		WHERE id_Cliente = UNHEX(xIdUsuario) AND deleted_at IS NULL;
	ELSEIF (Opcion = 4) THEN
		/*Consulta filtrada*/
		SELECT HEX(idPropuesta), HEX(id_Panel), HEX(id_Inversor), HEX(id_Cliente), HEX(id_Usuario), cTipoCotizacion, fPromedioKw, cTarifa, iCantidadPaneles, iCantidadInversores, fPotencialPropuesta, fNuevoConsumoBimestral, fNuevoConsumoAnual, tiPorcentajeDescuento, tiPorcentajePropuesta, fSubtotal, fTotal, siStatusProjejctFV, created_at, deleted_at, updated_at, expire_at
		FROM propuesta
		WHERE idPropuesta = UNHEX(xIdPropuesta);
	END IF;
END
// DELIMITER;